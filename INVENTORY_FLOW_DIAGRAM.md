# 📊 Схема работы загрузки инвентаря

## Общий flow

```
┌─────────────────────────────────────────────────────────────────┐
│                         ПОЛЬЗОВАТЕЛЬ                             │
│                                                                  │
│  1. Открывает /cabinet/inventory                                │
│  2. Нажимает "📥 Загрузить инвентарь"                           │
│  3. Вводит Steam ID / Trade URL / Profile URL                   │
└────────────────────────┬────────────────────────────────────────┘
                         │
                         ▼
┌─────────────────────────────────────────────────────────────────┐
│                      FRONTEND (React)                            │
│                                                                  │
│  • Парсит ссылку → извлекает Steam ID                          │
│  • Отправляет GET /api/inventory/{steam_id}                     │
└────────────────────────┬────────────────────────────────────────┘
                         │
                         ▼
┌─────────────────────────────────────────────────────────────────┐
│                    BACKEND (FastAPI)                             │
│                                                                  │
│  Endpoint: GET /api/inventory/{steam_id}                        │
│  ↓                                                               │
│  Вызывает: SteamService.get_inventory(steam_id)                 │
└────────────────────────┬────────────────────────────────────────┘
                         │
                         ▼
┌─────────────────────────────────────────────────────────────────┐
│              SteamService.get_inventory()                        │
│                                                                  │
│  МЕТОД 1: Публичный с retry ⭐                                  │
│  ├─ SteamAuthenticatedInventory.get_inventory_public()          │
│  ├─ Попытка 1 (задержка 1с)                                     │
│  ├─ Попытка 2 (задержка 2с)                                     │
│  └─ Попытка 3 (задержка 4с)                                     │
│                                                                  │
│  Если успех → возврат items ✅                                  │
│  Если нет ↓                                                      │
│                                                                  │
│  МЕТОД 2: Альтернативные методы                                 │
│  └─ SteamInventoryHelper.get_inventory_multi_method()           │
│                                                                  │
│  Если успех → возврат items ✅                                  │
│  Если нет ↓                                                      │
│                                                                  │
│  МЕТОД 3: Тестовые данные                                       │
│  └─ SteamService._get_demo_inventory()                          │
│                                                                  │
│  Возврат items (всегда) ✅                                      │
└────────────────────────┬────────────────────────────────────────┘
                         │
                         ▼
┌─────────────────────────────────────────────────────────────────┐
│                    ОБРАБОТКА РЕЗУЛЬТАТА                          │
│                                                                  │
│  • Получение цен с маркетов                                     │
│  • Добавление цен к предметам                                   │
│  • Подсчет общей стоимости                                      │
│  • Возврат JSON ответа                                          │
└────────────────────────┬────────────────────────────────────────┘
                         │
                         ▼
┌─────────────────────────────────────────────────────────────────┐
│                    FRONTEND (React)                              │
│                                                                  │
│  • Отображение предметов                                        │
│  • Фильтрация и сортировка                                      │
│  • Выбор предметов для сделки                                   │
└─────────────────────────────────────────────────────────────────┘
```

---

## Детальный flow публичного метода

```
┌─────────────────────────────────────────────────────────────────┐
│   SteamAuthenticatedInventory.get_inventory_public()             │
└────────────────────────┬────────────────────────────────────────┘
                         │
                         ▼
              ┌──────────────────────┐
              │   ПОПЫТКА 1          │
              │   Задержка: 1 сек    │
              └──────────┬───────────┘
                         │
                         ▼
              ┌──────────────────────┐
              │  GET запрос к Steam  │
              │  + Chrome заголовки  │
              └──────────┬───────────┘
                         │
                ┌────────┴────────┐
                │                 │
                ▼                 ▼
         ┌──────────┐      ┌──────────┐
         │ 200 OK   │      │  Ошибка  │
         └────┬─────┘      └────┬─────┘
              │                 │
              │                 ▼
              │          ┌──────────────┐
              │          │ 403 Forbidden│
              │          │ → Приватный  │
              │          │ → Возврат [] │
              │          └──────────────┘
              │                 │
              │                 ▼
              │          ┌──────────────┐
              │          │ 429 Rate Lim │
              │          │ → ПОПЫТКА 2  │
              │          │ Задержка: 2с │
              │          └──────┬───────┘
              │                 │
              │                 ▼
              │          ┌──────────────┐
              │          │ 500 Server   │
              │          │ → ПОПЫТКА 2  │
              │          │ Задержка: 2с │
              │          └──────┬───────┘
              │                 │
              │                 ▼
              │          ┌──────────────┐
              │          │   Timeout    │
              │          │ → ПОПЫТКА 2  │
              │          │ Задержка: 2с │
              │          └──────┬───────┘
              │                 │
              │                 ▼
              │          ┌──────────────┐
              │          │  ПОПЫТКА 3   │
              │          │ Задержка: 4с │
              │          └──────┬───────┘
              │                 │
              │                 ▼
              │          ┌──────────────┐
              │          │ Если не OK   │
              │          │ → Возврат [] │
              │          └──────────────┘
              │
              ▼
       ┌──────────────┐
       │ Парсинг JSON │
       │ assets +     │
       │ descriptions │
       └──────┬───────┘
              │
              ▼
       ┌──────────────┐
       │ Фильтр:      │
       │ tradable = 1 │
       └──────┬───────┘
              │
              ▼
       ┌──────────────┐
       │ Возврат items│
       │      ✅      │
       └──────────────┘
```

---

## Flow авторизованного метода (с cookies)

```
┌─────────────────────────────────────────────────────────────────┐
│                         ПОЛЬЗОВАТЕЛЬ                             │
│                                                                  │
│  1. Получает cookies из браузера (F12)                          │
│  2. Отправляет POST /api/inventory/authenticated/{steam_id}     │
│     Body: { "sessionid": "xxx", "steamLoginSecure": "yyy" }     │
└────────────────────────┬────────────────────────────────────────┘
                         │
                         ▼
┌─────────────────────────────────────────────────────────────────┐
│              BACKEND (FastAPI)                                   │
│                                                                  │
│  Endpoint: POST /api/inventory/authenticated/{steam_id}         │
│  ↓                                                               │
│  Извлекает cookies из body                                      │
│  ↓                                                               │
│  Вызывает: SteamAuthenticatedInventory                          │
│            .get_inventory_with_cookies()                        │
└────────────────────────┬────────────────────────────────────────┘
                         │
                         ▼
┌─────────────────────────────────────────────────────────────────┐
│   SteamAuthenticatedInventory.get_inventory_with_cookies()       │
│                                                                  │
│  • Добавляет cookies в запрос                                   │
│  • Эмулирует Chrome браузер                                     │
│  • Отправляет GET к Steam                                       │
│                                                                  │
│  Если успех → возврат items ✅                                  │
│  Если нет → fallback на публичный метод                         │
└────────────────────────┬────────────────────────────────────────┘
                         │
                         ▼
┌─────────────────────────────────────────────────────────────────┐
│                    ОБРАБОТКА РЕЗУЛЬТАТА                          │
│                                                                  │
│  • Получение цен                                                │
│  • Возврат JSON с пометкой "authenticated"                      │
└─────────────────────────────────────────────────────────────────┘
```

---

## Обработка ошибок

```
┌─────────────────────────────────────────────────────────────────┐
│                      ТИПЫ ОШИБОК                                 │
└─────────────────────────────────────────────────────────────────┘

┌──────────────┐
│ 403 Forbidden│
└──────┬───────┘
       │
       ▼
┌──────────────────────────────────────┐
│ Инвентарь приватный                  │
│ → Возврат []                         │
│ → Сообщение: "Откройте приватность"  │
│ → Или используйте cookies            │
└──────────────────────────────────────┘

┌──────────────┐
│ 429 Rate Lim │
└──────┬───────┘
       │
       ▼
┌──────────────────────────────────────┐
│ Rate limiting                        │
│ → Ждем 2^attempt секунд              │
│ → Retry (до 3 попыток)               │
│ → Exponential backoff                │
└──────────────────────────────────────┘

┌──────────────┐
│ 500 Server   │
└──────┬───────┘
       │
       ▼
┌──────────────────────────────────────┐
│ Ошибка сервера Steam                 │
│ → Ждем 2^attempt секунд              │
│ → Retry (до 3 попыток)               │
└──────────────────────────────────────┘

┌──────────────┐
│   Timeout    │
└──────┬───────┘
       │
       ▼
┌──────────────────────────────────────┐
│ Превышено время ожидания             │
│ → Увеличиваем timeout                │
│ → Retry (до 3 попыток)               │
└──────────────────────────────────────┘

┌──────────────┐
│ Empty Result │
└──────┬───────┘
       │
       ▼
┌──────────────────────────────────────┐
│ Инвентарь пустой                     │
│ → Возврат []                         │
│ → Fallback на тестовые данные        │
└──────────────────────────────────────┘
```

---

## Retry логика (Exponential Backoff)

```
Попытка 1:
├─ Задержка: 1 секунда
├─ Запрос к Steam
└─ Если ошибка → Попытка 2

Попытка 2:
├─ Задержка: 2 секунды (2^1)
├─ Запрос к Steam
└─ Если ошибка → Попытка 3

Попытка 3:
├─ Задержка: 4 секунды (2^2)
├─ Запрос к Steam
└─ Если ошибка → Возврат []

Общее время: 1 + 2 + 4 = 7 секунд максимум
```

---

## Сравнение методов

```
┌─────────────────────────────────────────────────────────────────┐
│                    ПУБЛИЧНЫЙ МЕТОД                               │
├─────────────────────────────────────────────────────────────────┤
│ ✅ Не требует авторизации                                       │
│ ✅ Работает для открытых инвентарей                             │
│ ✅ 3 попытки с retry                                            │
│ ✅ Обработка всех ошибок                                        │
│ ❌ Не работает для приватных                                    │
└─────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────┐
│                 АВТОРИЗОВАННЫЙ МЕТОД                             │
├─────────────────────────────────────────────────────────────────┤
│ ✅ Работает для приватных инвентарей                            │
│ ✅ Использует Steam cookies                                     │
│ ✅ Эмуляция настоящего браузера                                 │
│ ❌ Требует cookies из браузера                                  │
│ ❌ Cookies могут устареть                                       │
└─────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────┐
│                  ТЕСТОВЫЕ ДАННЫЕ                                 │
├─────────────────────────────────────────────────────────────────┤
│ ✅ Всегда работает                                              │
│ ✅ Для демонстрации функционала                                 │
│ ✅ 20 предметов разной редкости                                 │
│ ❌ Не реальные данные                                           │
└─────────────────────────────────────────────────────────────────┘
```

---

## Логирование

```
[PUBLIC_INVENTORY] Status: 200 for 76561198306528518
                   ↓
[PUBLIC_INVENTORY] Найдено 45 предметов
                   ↓
[PUBLIC_INVENTORY] ✅ Загружено 42 tradable предметов
                   ↓
[STEAM] ✅ Загружено 42 предметов через публичный API
```

При ошибках:
```
[PUBLIC_INVENTORY] Status: 429 for 76561198306528518
                   ↓
[PUBLIC_INVENTORY] Rate limit
                   ↓
[PUBLIC_INVENTORY] Попытка 2/3, ждем 2с...
                   ↓
[PUBLIC_INVENTORY] Status: 200 for 76561198306528518
                   ↓
[PUBLIC_INVENTORY] ✅ Загружено 42 tradable предметов
```

---

**Схема показывает полный flow загрузки инвентаря с обработкой всех случаев! 📊**
