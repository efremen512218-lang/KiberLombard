# Требования: Production-Ready КиберЛомбард

## Функциональные Требования

### FR-1: Агрегация Цен из Нескольких Источников
**Приоритет:** Критический  
**Статус:** Частично Реализовано

Система должна агрегировать цены из трёх источников:
1. **Steam Market** - Справочная цена
2. **Lis-Skins** - Instant sell цена (приоритет)
3. **market.csgo** - Рыночная/instant цена (резерв)

**Правила:**
- `instant_price = min(lis_price, market_csgo_price)`
- Принимать предмет только если: `lis_price > 0 AND instant_price >= 20₽`
- Кешировать цены на 1 час
- Fallback на кешированные цены если API недоступны

**Текущее Состояние:**
- ✅ Сервисы созданы: `lisskins_service.py`, `market_csgo_service.py`, `price_aggregator.py`
- ⚠️ Используются демо данные, не реальные API вызовы
- ✅ Кеширование реализовано
- ✅ Fallback логика существует

**Оставшаяся Работа:**
- Получить реальные API ключи
- Реализовать настоящие API вызовы
- Протестировать с production данными


### FR-2: Динамический Процент Займа
**Приоритет:** Критический  
**Статус:** Реализовано

Процент займа варьируется по цене предмета:
- 0-500₽ → 60%
- 500-5000₽ → 65%
- 5000+₽ → 70%

**Текущее Состояние:**
- ✅ Реализовано в `pricing_service.py`
- ✅ Конфигурируется в `config.py`

---

### FR-3: Гибкий Выбор Срока
**Приоритет:** Критический  
**Статус:** Backend Готов, Frontend Отсутствует

Пользователи могут выбрать срок выкупа от 7-30 дней с шагом 1 день.

**Проценты & Премия по Срокам:**
- 7 дней: 10% проценты + 5% премия
- 14 дней: 15% проценты + 7% премия
- 21 день: 20% проценты + 9% премия
- 30 дней: 25% проценты + 10% премия

**Промежуточные значения:** Линейная интерполяция

**Формула:**
```
loan_amount = sum(item.instant_price * get_loan_percent(item.instant_price))
base_buyback = loan_amount * (1 + interest)
buyback_price = base_buyback * (1 + premium)
```

**Текущее Состояние:**
- ✅ Backend логика в `pricing_service.py`
- ✅ Интерполяция реализована
- ❌ Frontend слайдер отсутствует

**Оставшаяся Работа:**
- Создать компонент TermSlider
- Добавить расчёт в реальном времени
- Отобразить разбивку

---

### FR-4: Верификация Телефона
**Приоритет:** Критический  
**Статус:** Backend Готов, Frontend Отсутствует

**Flow:**
1. Пользователь вводит телефон (+7XXXXXXXXXX)
2. Система отправляет 6-значный SMS код
3. Пользователь вводит код (TTL: 5 минут)
4. Система проверяет и помечает телефон как подтверждённый

**Безопасность:**
- Коды хешируются (SHA-256) перед сохранением
- Rate limit: 1 SMS в минуту на номер
- Коды истекают через 5 минут

**Текущее Состояние:**
- ✅ `sms_service.py` создан
- ✅ Поддержка fake, sms.ru, smsc.ru провайдеров
- ✅ Endpoints существуют в `main.py`
- ❌ Frontend компонент отсутствует

**Оставшаяся Работа:**
- Создать компонент PhoneVerification
- Получить API ключ SMS провайдера
- Протестировать с реальными SMS

---

### FR-5: Верификация Паспорта (KYC)
**Приоритет:** Критический  
**Статус:** Backend Готов, Frontend Отсутствует

**Обязательные Поля:**
- ФИО (3 поля: фамилия, имя, отчество)
- Дата рождения
- Серия и номер паспорта
- Кем выдан
- Дата выдачи
- Код подразделения
- Фото скана паспорта

**Flow Верификации:**
1. Пользователь отправляет форму с фото
2. Данные отправляются KYC провайдеру (Sumsub)
3. Провайдер проверяет подлинность документа
4. Статус: pending → passed/failed
5. Пользователь не может создавать сделки без статуса passed

**Текущее Состояние:**
- ✅ `kyc_service.py` создан
- ✅ Поддержка fake, sumsub провайдеров
- ✅ Базовые endpoints существуют
- ❌ Frontend форма отсутствует
- ❌ Загрузка фото не реализована

**Оставшаяся Работа:**
- Создать компонент PassportForm
- Реализовать загрузку фото
- Получить API ключ Sumsub
- Добавить polling статуса

---

### FR-6: Электронное Подписание Договора
**Приоритет:** Критический  
**Статус:** Backend Готов, Frontend Отсутствует

**Flow Подписания:**
1. Пользователь просматривает договор (PDF)
2. Ставит галочку "Я согласен"
3. Нажимает "Подписать" → отправляется SMS код
4. Пользователь вводит код подписи
5. Система создаёт запись подписи
6. Генерируется PDF договора с деталями подписи

**Запись Подписи:**
- User ID, deal ID, телефон
- Хеш кода подписи
- Timestamp, IP адрес, user-agent
- Хеш договора (SHA-256)
- Версия договора
- ID KYC верификации

**Текущее Состояние:**
- ✅ `contract_service.py` создан
- ✅ Генерация HTML договора
- ✅ Расчёт хеша
- ❌ Генерация PDF не реализована
- ❌ Frontend компонент отсутствует
- ❌ Модель DealSignature отсутствует

**Оставшаяся Работа:**
- Добавить модель DealSignature
- Реализовать генерацию PDF (weasyprint)
- Создать компонент ContractSigning
- Добавить endpoints подписи

---

### FR-7: Выплаты СБП
**Приоритет:** Критический  
**Статус:** Backend Готов, Frontend Отсутствует

**Flow Выплаты:**
1. Сделка подписана и трейд принят
2. Система создаёт выплату СБП
3. Деньги отправляются на номер телефона пользователя
4. Отслеживание статуса: pending → processing → completed/failed

**Лимиты:**
- Мин: 100₽
- Макс: 600,000₽

**Текущее Состояние:**
- ✅ `sbp_service.py` создан
- ✅ Поддержка fake, modulbank провайдеров
- ❌ Модель SBPPayout отсутствует
- ❌ Endpoints выплат отсутствуют
- ❌ Frontend интеграция отсутствует

**Оставшаяся Работа:**
- Добавить модель SBPPayout
- Добавить endpoints выплат
- Получить API ключ Modulbank
- Реализовать webhook handler
- Добавить polling статуса

---

### FR-8: Audit Логирование
**Приоритет:** Критический  
**Статус:** Частично Реализовано

**Требования:**
- Логировать все критичные действия
- Включать: user_id, deal_id, action, timestamp, IP, user-agent, details (JSON)
- Неизменяемые логи (append-only)
- Admin endpoint для экспорта юридического пакета

**Действия для Логирования:**
- steam_login
- phone_verified
- kyc_submitted
- kyc_verified
- deal_created
- contract_signed
- trade_sent
- trade_accepted
- payout_created
- payout_completed
- buyback_initiated
- buyback_completed
- deal_defaulted

**Текущее Состояние:**
- ✅ Модель AuditLog существует
- ✅ Некоторые действия логируются
- ❌ Не все критичные действия логируются
- ❌ IP/user-agent не захватываются везде
- ❌ Endpoint юридического пакета отсутствует

**Оставшаяся Работа:**
- Добавить middleware для захвата IP/user-agent
- Логировать все критичные действия
- Создать endpoint юридического пакета
- Протестировать полноту логов

---

## Нефункциональные Требования

### NFR-1: Производительность
- Получение цен: < 3 секунд для 50 предметов
- Время ответа API: < 500ms (95-й перцентиль)
- Запросы к БД: < 100ms
- Cache hit rate: > 80% для цен

### NFR-2: Надёжность
- Uptime API: 99.5%
- Fallback на кешированные цены если внешние API недоступны
- Graceful degradation (показывать оценочные цены при необходимости)
- Retry логика для временных сбоев

### NFR-3: Безопасность
- Все чувствительные данные зашифрованы в покое
- SMS коды хешируются перед сохранением
- Хеши договоров для неизменяемости
- Rate limiting на SMS endpoints
- Валидация ввода на всех endpoints
- Защита от SQL injection (использование ORM)

### NFR-4: Юридическое Соответствие
- Все договоры версионируются
- Все подписи логируются с полным контекстом
- Audit логи неизменяемы
- Хранение данных: минимум 5 лет
- Соответствие GDPR (экспорт/удаление данных)

### NFR-5: Удобство Использования
- Понятные сообщения об ошибках на русском
- Индикаторы загрузки для async операций
- Обновление цен в реальном времени
- Адаптивный UI для мобильных
- Доступность (WCAG 2.1 AA)

---

## Требования к Данным

### DR-1: Данные Цен
**Источник:** Lis-Skins, market.csgo, Steam Market  
**Частота Обновления:** По запросу с кешем на 1 час  
**Хранение:** 30 дней исторических цен  
**Объём:** ~10,000 предметов × 3 источника = 30,000 записей цен

### DR-2: Данные Пользователей
**PII:** Телефон, данные паспорта, ФИО  
**Хранение:** Активные пользователи + 5 лет после последней сделки  
**Шифрование:** В покое и при передаче  
**Бэкап:** Ежедневно, хранение 30 дней

### DR-3: Данные Сделок
**Хранение:** Постоянное (юридическое требование)  
**Бэкап:** Ежедневно, постоянное хранение  
**Audit:** Все изменения логируются

### DR-4: Audit Логи
**Хранение:** Постоянное  
**Неизменяемость:** Append-only  
**Бэкап:** Ежедневно, постоянное хранение

---

## Требования к Интеграциям

### INT-1: Lis-Skins API
**Цель:** Получение instant sell цен  
**Аутентификация:** API ключ  
**Rate Limit:** TBD (проверить документацию)  
**Endpoint:** `https://lis-skins.ru/api/v2/prices`  
**Статус:** Не интегрировано (используются демо данные)

### INT-2: market.csgo API
**Цель:** Получение рыночных/instant цен  
**Аутентификация:** API ключ  
**Rate Limit:** TBD (проверить документацию)  
**Endpoint:** `https://market.csgo.com/api/v2/prices`  
**Статус:** Не интегрировано (используются демо данные)

### INT-3: SMS Провайдер (sms.ru или smsc.ru)
**Цель:** Отправка кодов верификации и подписи  
**Аутентификация:** API ключ  
**Rate Limit:** Лимиты аккаунта  
**Стоимость:** ~3₽ за SMS  
**Статус:** Fake провайдер для dev

### INT-4: KYC Провайдер (Sumsub)
**Цель:** Верификация паспортных документов  
**Аутентификация:** API ключ + secret  
**Стоимость:** За верификацию  
**Статус:** Fake провайдер для dev

### INT-5: СБП Провайдер (Modulbank)
**Цель:** Отправка выплат  
**Аутентификация:** API ключ  
**Лимиты:** 100₽ - 600,000₽  
**Стоимость:** Комиссия за выплату  
**Статус:** Fake провайдер для dev

### INT-6: Steam Bot API
**Цель:** Создание trade offers  
**Аутентификация:** Внутренняя  
**Endpoint:** `http://localhost:3001/api/trade/*`  
**Статус:** Реализовано

---

## Требования к Конфигурации

### Необходимые Переменные Окружения

```env
# База данных
DATABASE_URL=postgresql://user:pass@localhost/cyberlombard

# Steam
STEAM_API_KEY=xxx
STEAM_BOT_API_URL=http://localhost:3001

# Цены
LIS_SKINS_API_KEY=xxx
MARKET_CSGO_API_KEY=xxx

# SMS
SMS_PROVIDER=fake  # или sms.ru, smsc.ru
SMS_API_KEY=xxx

# KYC
KYC_PROVIDER=fake  # или sumsub
KYC_API_KEY=xxx
KYC_API_SECRET=xxx

# Выплаты
SBP_PROVIDER=fake  # или modulbank
SBP_API_KEY=xxx

# Безопасность
SECRET_KEY=xxx
JWT_SECRET=xxx

# Лимиты
MIN_INSTANT_PRICE=20.0
MIN_TERM_DAYS=7
MAX_TERM_DAYS=30
```

---

## Требования к Тестированию

### Unit Тесты
- [ ] Расчёты цен (все формулы)
- [ ] Интерполяция сроков
- [ ] Генерация/верификация SMS кодов
- [ ] Расчёт хеша договора
- [ ] Логика агрегации цен

### Интеграционные Тесты
- [ ] Полный flow создания сделки
- [ ] Flow KYC верификации
- [ ] Flow подписания договора
- [ ] Flow выплаты
- [ ] Получение цен с fallback

### E2E Тесты
- [ ] Пользователь создаёт аккаунт
- [ ] Пользователь подтверждает телефон
- [ ] Пользователь отправляет KYC
- [ ] Пользователь создаёт сделку с реальными ценами
- [ ] Пользователь подписывает договор
- [ ] Пользователь получает выплату
- [ ] Пользователь инициирует выкуп

### Тесты Производительности
- [ ] Загрузка 100 предметов с ценами
- [ ] 100 одновременных пользователей
- [ ] Производительность запросов к БД
- [ ] Эффективность кеша

---

## Матрица Приоритетов

| Функция | Приоритет | Сложность | Статус |
|---------|-----------|-----------|--------|
| Мульти-источник цен | Критический | Средняя | 70% |
| Слайдер срока | Критический | Низкая | 50% |
| Верификация телефона | Критический | Средняя | 70% |
| KYC верификация | Критический | Высокая | 60% |
| Подписание договора | Критический | Высокая | 60% |
| Выплаты СБП | Критический | Средняя | 60% |
| Audit логирование | Критический | Средняя | 50% |
| Реальные API интеграции | Критический | Средняя | 0% |
| Frontend компоненты | Критический | Средняя | 20% |
| Тестирование | Высокий | Высокая | 10% |
| Документация | Высокий | Низкая | 30% |

---

## Следующие Шаги

1. **Немедленно (Сегодня):**
   - Добавить отсутствующие модели БД (KYCVerification, DealSignature, SBPPayout)
   - Создать миграцию БД
   - Протестировать модели

2. **Краткосрочно (Эта Неделя):**
   - Реализовать отсутствующие API endpoints
   - Создать frontend компоненты
   - Интегрировать компоненты в flow сделки

3. **Среднесрочно (Следующая Неделя):**
   - Получить реальные API ключи
   - Реализовать реальные API интеграции
   - Всестороннее тестирование

4. **Перед Production:**
   - Аудит безопасности
   - Юридическая проверка
   - Тестирование производительности
   - Завершение документации

---

## Оценка Времени до Production

- Модели БД + миграция: 2-4 часа
- Отсутствующие API endpoints: 4-6 часов  
- Frontend компоненты: 6-8 часов
- Реальные API интеграции: 4-6 часов
- Тестирование: 4-6 часов
- **Итого: 20-30 часов сфокусированной работы**
