# Спецификация: Production Реализация - Live Цены & Полный KYC

## Обзор
Завершить production-ready реализацию КиберЛомбард с live ценами из нескольких источников, полной KYC верификацией, гибким выбором срока и юридическим соответствием для судебных разбирательств.

## Текущий Статус
- ✅ Фазы 1-5 сервисы созданы (pricing, KYC, contracts, payouts)
- ✅ Базовые модели БД существуют
- ⚠️ Отсутствуют: Новые модели БД для KYC, подписей, audit логов
- ⚠️ Отсутствуют: API endpoints для KYC, подписания договора, выплат
- ⚠️ Отсутствуют: Frontend компоненты для слайдера срока, KYC форм, подписания
- ⚠️ Используются демо цены вместо реальных API интеграций

## Пользовательские Истории

### US-1: Live Цены из Нескольких Источников
**Как** пользователь  
**Я хочу** видеть цены в реальном времени из Lis-Skins, market.csgo и Steam Market  
**Чтобы** знать точную стоимость моих предметов и сумму займа, которую я получу

**Критерии Приёмки:**
- Карточки предметов показывают 3 цены: Steam Market, Lis-Skins, market.csgo
- Instant цена рассчитывается как min(lis_price, market_csgo_price)
- Предметы без instant sell цены на Lis-Skins помечены как "не принимаем"
- Предметы с instant_price < 20₽ не принимаются
- Цены кешируются на 1 час
- Понятные сообщения об ошибках когда API недоступны

### US-2: Гибкий Выбор Срока (7-30 Дней)
**Как** пользователь  
**Я хочу** выбрать срок выкупа от 7 до 30 дней с помощью слайдера  
**Чтобы** выбрать условия, которые подходят моей финансовой ситуации

**Критерии Приёмки:**
- Слайдер позволяет выбор от 7 до 30 дней (шаг 1 день)
- Цена выкупа обновляется в реальном времени при движении слайдера
- Проценты и премия интерполируются для промежуточных значений
- Дата истечения рассчитывается и отображается
- Детальная разбивка показывает: процент займа, проценты, премию

### US-3: Верификация Телефона через SMS
**Как** пользователь  
**Я хочу** подтвердить свой номер телефона через SMS код  
**Чтобы** продолжить создание сделок

**Критерии Приёмки:**
- Пользователь вводит номер телефона (формат +7XXXXXXXXXX)
- Отправляется 6-значный SMS код (TTL: 5 минут)
- Пользователь вводит код для подтверждения
- Ограничение: 1 SMS в минуту на номер
- Код хешируется перед сохранением
- Понятные сообщения об ошибках для неверных/истекших кодов

### US-4: Верификация Паспорта (KYC)
**Как** пользователь  
**Я хочу** отправить данные паспорта  
**Чтобы** завершить KYC верификацию для сделок

**Критерии Приёмки:**
- Форма собирает: ФИО, дату рождения, серию/номер паспорта, кем выдан, дату выдачи, код подразделения
- Загрузка фото скана паспорта
- Данные отправляются KYC провайдеру (sumsub или fake для dev)
- Отслеживание статуса: pending → passed/failed
- Пользователь не может продолжить без статуса passed
- Понятная обратная связь о статусе верификации

### US-5: Электронное Подписание Договора
**Как** пользователь  
**Я хочу** подписать договор электронно через SMS  
**Чтобы** сделка была юридически обязывающей

**Критерии Приёмки:**
- Пользователь просматривает полный договор (PDF)
- Чекбокс: "Я согласен с условиями"
- Кнопка "Подписать" отправляет SMS с кодом подписи
- Пользователь вводит код подписи для завершения
- Генерируется PDF договора с деталями подписи
- Хеш договора (SHA-256) сохраняется для неизменяемости
- Все детали подписания логируются: timestamp, IP, user-agent, телефон

### US-6: Выплата через СБП
**Как** пользователь  
**Я хочу** получить сумму займа через СБП (Система Быстрых Платежей)  
**Чтобы** получить деньги быстро без комиссий

**Критерии Приёмки:**
- Пользователь выбирает СБП как способ выплаты
- Выплата создаётся через провайдера (modulbank или fake для dev)
- Отслеживание статуса: pending → processing → completed/failed
- Понятные сообщения об ошибках если выплата не прошла
- Лимиты выплат: 100₽ - 600,000₽

### US-7: Audit Логирование для Юридического Соответствия
**Как** системный администратор  
**Я хочу** чтобы все критичные действия логировались с полным контекстом  
**Чтобы** у нас были доказательства для судебных разбирательств при необходимости

**Критерии Приёмки:**
- Все критичные действия логируются: вход, создание сделки, подписание договора, трейды, выплаты
- Каждый лог включает: user_id, deal_id, action, timestamp, IP, user-agent, details (JSON)
- Admin endpoint для экспорта полного юридического пакета по сделке
- Юридический пакет включает: данные сделки, данные пользователя, KYC верификацию, детали подписи, трейды, выплаты, audit логи

## Технические Требования

### Модели БД для Добавления

```python
class KYCVerification(Base):
    """Записи верификации паспорта"""
    id: int
    user_id: int
    verification_id: str  # ID внешнего провайдера
    status: str  # pending, passed, failed
    full_name: str
    birth_date: date
    passport_series: str
    passport_number: str
    issued_by: str
    issue_date: date
    department_code: str
    photo_url: str
    provider_response: JSON
    created_at: datetime
    verified_at: datetime

class DealSignature(Base):
    """Записи электронной подписи"""
    id: int
    deal_id: int
    user_id: int
    phone: str
    signature_code_hash: str
    signature_timestamp: datetime
    ip_address: str
    user_agent: str
    contract_hash: str
    contract_version: str
    contract_pdf_url: str
    kyc_verification_id: str
    terms_accepted_at: datetime

class SBPPayout(Base):
    """Записи выплат СБП"""
    id: int
    deal_id: int
    payout_id: str  # ID внешнего провайдера
    phone: str
    amount: float
    status: str  # pending, processing, completed, failed
    error_code: str
    error_message: str
    provider_response: JSON
    created_at: datetime
    updated_at: datetime
    completed_at: datetime
```

### API Endpoints для Добавления

```
POST /api/kyc/phone/send-code
POST /api/kyc/phone/verify-code
POST /api/kyc/passport/submit
GET  /api/kyc/passport/status/{verification_id}

POST /api/deals/{deal_id}/sign/init
POST /api/deals/{deal_id}/sign/complete
GET  /api/deals/{deal_id}/contract

POST /api/deals/{deal_id}/payout/create
GET  /api/deals/{deal_id}/payout/status

GET  /api/admin/deals/{deal_id}/legal-package
```

### Frontend Компоненты для Создания

```
components/TermSlider.tsx
  - Range input 7-30 дней
  - Расчёт выкупа в реальном времени
  - Отображение даты истечения
  - Разбивка процентов/премии

components/PhoneVerification.tsx
  - Ввод телефона с валидацией
  - Кнопка отправки кода
  - Ввод кода (6 цифр)
  - Кнопка подтверждения
  - Обратная связь о статусе

components/PassportForm.tsx
  - Все поля паспорта
  - Загрузка фото
  - Кнопка отправки
  - Отображение статуса

components/ContractSigning.tsx
  - Просмотр PDF договора
  - Чекбокс условий
  - Кнопка подписи (отправляет SMS)
  - Ввод кода подписи
  - Кнопка завершения

components/ItemCard.tsx (обновить)
  - Отображение 3 цен
  - Показ instant цены
  - Пометка неприемлемых предметов
  - Визуальные индикаторы
```

## План Реализации

### Фаза 1: Модели БД (2-4 часа)
1. Добавить модели KYCVerification, DealSignature, SBPPayout в `backend/models.py`
2. Создать Alembic миграцию
3. Запустить миграцию на dev БД
4. Протестировать связи моделей

### Фаза 2: API Endpoints (4-6 часов)
1. Реализовать KYC endpoints в `backend/main.py`
2. Реализовать endpoints подписания договора
3. Реализовать endpoints выплат
4. Добавить middleware для логирования IP/user-agent
5. Протестировать все endpoints с Postman/curl

### Фаза 3: Frontend Компоненты (6-8 часов)
1. Создать компонент TermSlider с live расчётом
2. Создать компонент PhoneVerification
3. Создать компонент PassportForm
4. Создать компонент ContractSigning
5. Обновить ItemCard для показа нескольких цен
6. Интегрировать компоненты в flow сделки

### Фаза 4: Реальные API Интеграции (4-6 часов)
1. Получить API ключи от Lis-Skins, market.csgo
2. Обновить `lisskins_service.py` с реальными API вызовами
3. Обновить `market_csgo_service.py` с реальными API вызовами
4. Протестировать получение цен с реальными данными
5. Проверить работу fallback логики

### Фаза 5: Тестирование (4-6 часов)
1. Unit тесты для расчётов цен
2. Unit тесты для KYC сервисов
3. Интеграционные тесты для полного flow сделки
4. E2E тест: создание сделки с реальными ценами
5. Тестирование сценариев ошибок

### Фаза 6: Конфигурация & Деплой (2-4 часа)
1. Обновить `.env.example` со всеми необходимыми ключами
2. Документировать процесс получения API ключей
3. Тестировать с fake провайдерами
4. Тестировать с реальными провайдерами (staging)
5. Деплой в production

## Критерии Готовности

- [ ] Все модели БД созданы и мигрированы
- [ ] Все API endpoints реализованы и протестированы
- [ ] Все frontend компоненты созданы и интегрированы
- [ ] Реальные API интеграции работают (или fake провайдеры для dev)
- [ ] Полный flow сделки работает end-to-end
- [ ] Все критичные действия логируются
- [ ] Обработка ошибок всеобъемлющая
- [ ] Документация обновлена
- [ ] Код проверен и одобрен

## Риски & Меры Снижения

**Риск:** API ключи недоступны  
**Снижение:** Использовать fake провайдеры для разработки, чётко помечать demo режим в UI

**Риск:** Интеграция KYC провайдера сложная  
**Снижение:** Начать с fake провайдера, документировать требования интеграции

**Риск:** Стоимость SMS слишком высокая  
**Снижение:** Реализовать rate limiting, использовать fake провайдер для dev/тестирования

**Риск:** Требования юридического соответствия меняются  
**Снижение:** Сделать шаблоны договоров конфигурируемыми, версионировать все договоры

## Метрики Успеха

- Все предметы показывают реальные цены из 3 источников
- Пользователи могут выбрать любой срок от 7-30 дней
- KYC верификация завершается за < 5 минут
- Подписание договора работает через SMS
- Выплаты завершаются за < 5 минут
- 100% критичных действий логируются
- Нулевая потеря данных в audit логах

## Примечания

- Все сервисы поддерживают fake провайдеры для разработки
- Реальные интеграции требуют API ключи от внешних провайдеров
- Юридическое соответствие критично - все действия должны логироваться
- Язык договора избегает запрещённых терминов (ломбард, залог, кредит)
- Используется терминология "выкуп цифровых прав" и "опцион"
